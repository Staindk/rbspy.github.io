<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Questions to ask - rbspy: A Sampling CPU Profiler for Ruby</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../installing.html"><strong aria-hidden="true">2.</strong> Installing</a></li><li class="chapter-item expanded "><a href="../using-rbspy/index.html"><strong aria-hidden="true">3.</strong> Using rbspy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../using-rbspy/snapshot.html"><strong aria-hidden="true">3.1.</strong> snapshot</a></li><li class="chapter-item expanded "><a href="../using-rbspy/record.html"><strong aria-hidden="true">3.2.</strong> record</a></li><li class="chapter-item expanded "><a href="../using-rbspy/report.html"><strong aria-hidden="true">3.3.</strong> report</a></li></ol></li><li class="chapter-item expanded "><a href="../rbspy-vs-stackprof.html"><strong aria-hidden="true">4.</strong> rbspy vs stackprof</a></li><li class="chapter-item expanded "><a href="../profiling-guide/index.html"><strong aria-hidden="true">5.</strong> Profiling guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../profiling-guide/questions-to-ask.html" class="active"><strong aria-hidden="true">5.1.</strong> Questions to ask</a></li><li class="chapter-item expanded "><a href="../profiling-guide/benchmarking-your-code.html"><strong aria-hidden="true">5.2.</strong> Benchmarking your code</a></li><li class="chapter-item expanded "><a href="../profiling-guide/using-flamegraphs.html"><strong aria-hidden="true">5.3.</strong> Using flamegraphs</a></li></ol></li><li class="chapter-item expanded "><a href="../getting-help.html"><strong aria-hidden="true">6.</strong> Getting help</a></li><li class="chapter-item expanded "><a href="../contributing.html"><strong aria-hidden="true">7.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">8.</strong> FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rbspy: A Sampling CPU Profiler for Ruby</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rbspy/rbspy.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="questions-to-ask-when-optimizing-code"><a class="header" href="#questions-to-ask-when-optimizing-code">Questions to ask when optimizing code</a></h1>
<p>When people start looking at profiling data, they're often unsure of where to start.</p>
<p>If you have a slow program that you want to start optimizing, here are a few questions to consider
using your profiling tools to answer.</p>
<h3 id="is-my-program-mostly-using-the-cpu-or-mostly-waiting"><a class="header" href="#is-my-program-mostly-using-the-cpu-or-mostly-waiting">Is my program mostly using the CPU or mostly waiting?</a></h3>
<p>If your program is slow, the first most important thing to find out is whether it's slow because
it's using the CPU or if it's slow because it's waiting for the disk or network or something.</p>
<p>If your program is spending 98% of its time waiting for the result of a database query, it's very
possible that you don't need to change your program's code at all, and what you need to do is work
on your database's indexes!</p>
<h3 id="is-my-program-swapping-memory-to-disk"><a class="header" href="#is-my-program-swapping-memory-to-disk">Is my program swapping memory to disk?</a></h3>
<p>This isn't a question that profilers can answer, but if your program is using a lot of memory (more
than is available on your machine), it's worth checking whether the program is swapping memory to
disk. Swapping will make your program run a lot slower, especially if your swap partition is
encrypted.</p>
<h3 id="is-there-a-single-function-where-all-the-time-is-being-spent"><a class="header" href="#is-there-a-single-function-where-all-the-time-is-being-spent">Is there a single function where all the time is being spent?</a></h3>
<p>Sometimes when a program is really unexpectedly slow, there's one function which is overwhelmingly
the culprit. Profilers can tell you what % of your program's execution time was spent in each
function.</p>
<p>When thinking about this question it's useful to understand the difference between &quot;self time&quot; and
&quot;total time&quot; spent in a function -- a lot of profilers (including rbspy) will give you a report like
this:</p>
<pre><code>% self  % total  name
  3.05    10.09  each_child_node
  2.52    31.14  block (2 levels) in on_send
  2.17    14.31  do_parse
  1.76     3.28  cop_config
  1.70     2.29  block (2 levels) in &lt;class:Node&gt;
  1.41     1.41  end_pos
</code></pre>
<p>The <strong>self time</strong> is the percentage of time that function was at the top of the call stack.
Basically -- if the function is doing computations itself (vs calling other functions), it's what %
of time was spent in those functions.</p>
<p><strong>Looking for functions with high self time can be a good way to find low-hanging fruit for
optimizations</strong> -- if 20% of the time is being spent in a single function's calculations and you
can make that function 90% faster, then you've improved your program's overall speed a lot! For
example, if you have a slow calculation, maybe you can cache it!</p>
<p>The <strong>total time</strong> is the percentage of time that function appeared in a call stack. Basically it's
the % of time spent in the function itself + every other function it called.</p>
<p>Both self time and total time are important to consider -- for example, if I have a function that
does this:</p>
<pre><code>def parent_fun
    for x in list1
        for y in list2
            child_fun(x,y)
        end
    end
end
</code></pre>
<p>your profiler might report that <code>parent_fun</code> has 0% &quot;self time&quot; (because all it does is call
<code>child_fun</code> over and over again), but maybe it's still possible to optimize the algorithm it uses.</p>
<h3 id="how-many-times-is-function-x-being-called"><a class="header" href="#how-many-times-is-function-x-being-called">How many times is function X being called?</a></h3>
<p>If your profiler says that 98% of the time is being spent inside a single function
like <code>calculate_thing</code>, you're not done! There are 2 possible cases here:</p>
<ul>
<li><code>calculate_thing</code> is taking a long time</li>
<li><code>calculate_thing</code> is fast, but another function is <strong>calling</strong> that function way too many times.
No use having a fast function if it's being called 100 million times!</li>
</ul>
<p>Because rbspy is a sampling profiler (not a tracing profiler), it actually can't tell you how times
a function was called -- it just reports &quot;hey, I observed your program 100,000 times, and 98,000 of
those times it was in the <code>calculate_thing</code> function&quot;.</p>
<p><a href="https://github.com/ruby-prof/ruby-prof">ruby-prof</a> is a tracing profiler for Ruby, which can tell
you exactly how many times each function was called at the cost of being higher overhead.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../profiling-guide/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../profiling-guide/benchmarking-your-code.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../profiling-guide/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../profiling-guide/benchmarking-your-code.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
