<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Benchmarking your code - rbspy</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../installing.html"><strong aria-hidden="true">2.</strong> Installing</a></li><li class="chapter-item expanded "><a href="../using-rbspy/index.html"><strong aria-hidden="true">3.</strong> Using rbspy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../using-rbspy/snapshot.html"><strong aria-hidden="true">3.1.</strong> snapshot</a></li><li class="chapter-item expanded "><a href="../using-rbspy/record.html"><strong aria-hidden="true">3.2.</strong> record</a></li><li class="chapter-item expanded "><a href="../using-rbspy/report.html"><strong aria-hidden="true">3.3.</strong> report</a></li></ol></li><li class="chapter-item expanded "><a href="../rbspy-vs-stackprof.html"><strong aria-hidden="true">4.</strong> rbspy vs stackprof</a></li><li class="chapter-item expanded "><a href="../profiling-guide/index.html"><strong aria-hidden="true">5.</strong> Profiling guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../profiling-guide/questions-to-ask.html"><strong aria-hidden="true">5.1.</strong> Questions to ask when optimizing code</a></li><li class="chapter-item expanded "><a href="../profiling-guide/benchmarking-your-code.html" class="active"><strong aria-hidden="true">5.2.</strong> Benchmarking your code</a></li><li class="chapter-item expanded "><a href="../profiling-guide/using-flamegraphs.html"><strong aria-hidden="true">5.3.</strong> Using flamegraphs</a></li></ol></li><li class="chapter-item expanded "><a href="../getting-help.html"><strong aria-hidden="true">6.</strong> Getting help</a></li><li class="chapter-item expanded "><a href="../contributing.html"><strong aria-hidden="true">7.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">8.</strong> FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rbspy</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="benchmarking-your-code"><a class="header" href="#benchmarking-your-code">Benchmarking your code</a></h1>
<p>People who are just getting started making their code faster sometimes confuse <strong>benchmarking</strong> and
<strong>profiling</strong>. Let's explain the difference and how to use both techniques to make your code faster!</p>
<p>In short: a benchmark tells you <strong>how slow</strong> your code is (&quot;it took 20 seconds to do X Y Z&quot;) and a
profiler tells you <strong>why it's slow</strong> (&quot;35% of that time was spent doing compression&quot;).</p>
<h2 id="whats-benchmarking-why-is-it-important"><a class="header" href="#whats-benchmarking-why-is-it-important">What's benchmarking? Why is it important?</a></h2>
<p>Optimizing code is often very counterintuitive -- often I'll have a great idea for how to make my
code faster, and it'll turn out to make almost no difference at all in practice. So when optimizing,
it's extremely important to have objective standards you can measure your changes against!</p>
<p>A <strong>benchmark</strong> is a test that you run to measure how fast your code is. For example, if I have a
compression library, I might test how long it takes to compress a given 100MB file. Or if I was
working on Jekyll's performance (a static site generator), I might take a specific large site and
benchmark how long Jekyll takes to render that site.</p>
<p>If you can run the benchmark on your dev machine, you can make changes, see &quot;oh, that didn't make
any difference!&quot;, and then quickly try out a different approach.</p>
<h2 id="run-your-benchmarks-more-than-once"><a class="header" href="#run-your-benchmarks-more-than-once">Run your benchmarks more than once</a></h2>
<p>Suppose you run your benchmark and it takes 6 seconds. You make some optimizations and run it again,
and afterwards it takes 5.7 seconds. That's a 5% performance improvement, right? Not huge, but not
nothing?</p>
<p>Not necessarily!</p>
<p>Here's a real benchmark from my computer (generating a Jekyll site), and how long it took (in
seconds) across 10 different runs:</p>
<pre><code>5.94
6.00
6.04
5.98
6.15
6.37
6.14
6.20
5.98
6.18
6.22
6.04
6.16
</code></pre>
<p>When I ran it 100 times, there was even more variation -- sometimes it would take up to 9 seconds
(for instance if I was using a lot of CPU).</p>
<p>So the same benchmark, on the same computer, can take anywhere between 6 to 9 seconds.
This means that if, for this benchmark, I see a performance improvement of less than 0.5 seconds
(~10%) or so, it's worth being suspicious.</p>
<p>We don't have time here to do a rigorous discussion of statistics and benchmarking, but here are a
few guidelines:</p>
<ul>
<li>be suspicious of small performance improvements (like 5% or 10%). The smaller the performance
improvement you're trying to verify, the more times you need to run your benchmark to be sure that
it's real.</li>
<li>running any benchmark 10 times instead of just once is a good way to get an idea of how much
natural variation that benchmark has.</li>
</ul>
<p>If you're interested in taking a more statistically rigorous approach, a good starting point is to
look up &quot;bootstrap confidence intervals&quot;, which is an easy computational way (very little math!) to
get confidence intervals.</p>
<h2 id="using-benchmarking--profiling-to-make-your-code-faster"><a class="header" href="#using-benchmarking--profiling-to-make-your-code-faster">Using benchmarking + profiling to make your code faster</a></h2>
<p>There are basically 2 typical workflows you can use when optimizing your code. Basically: you can
either profile a benchmark of your code, or you can profile your code running in production.</p>
<p>Both of these techniques are basically the same: measure your code's speed somehow, profile it, come
up with potentially faster code, and then measure again afterwards to see if it actually worked!</p>
<p>The most important tip here is: <strong>don't use profiler results to figure out if your optimization
worked, use benchmark results</strong>. Using benchmark results will help you make sure that your
optimization actually makes a significant improvement to the program's performance as a whole.</p>
<h3 id="technique-1-benchmark-locally"><a class="header" href="#technique-1-benchmark-locally">Technique 1: Benchmark locally</a></h3>
<ol>
<li>Realize something is slow (&quot;oh no, this computation is taking SO LONG, why??&quot;)</li>
<li>Create a <strong>benchmark</strong> that you can run locally that demonstrates the slow behavior. This doesn't
need to be complicated!</li>
<li>Run your benchmark (10 times!) to get a baseline for how long it takes</li>
<li>Profile the benchmark.</li>
<li>Implement a fix</li>
<li>Run your benchmark again to see if your fix worked!</li>
</ol>
<h3 id="technique-2-monitor-production-performance"><a class="header" href="#technique-2-monitor-production-performance">Technique 2: Monitor production performance</a></h3>
<p>This technique has a little less of the scientific rigor that you get when you make a benchmark, but
often making a benchmark isn't practical! A lot of things happen in production that are hard to
reproduce, but you need to figure out why they're happening anyway.</p>
<ol>
<li>Realize something is slow (your users are complaining about performance!)</li>
<li>Find a way to monitor the slow thing in production with your favorite monitoring tool (graphite,
datadog, new relic, whatever)</li>
<li>Profile the code running in production</li>
<li>Implement a fix and deploy it to a test environment or to production</li>
<li>Use your monitoring to see if the performance improved!</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../profiling-guide/questions-to-ask.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../profiling-guide/using-flamegraphs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../profiling-guide/questions-to-ask.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../profiling-guide/using-flamegraphs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
